<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shiptrack - Seguimiento de Carga</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors">

  <!-- HEADER -->
  <header class="bg-blue-800 dark:bg-gray-800 text-white p-4 flex justify-between items-center shadow-md">
    <div class="flex items-center space-x-3">
      <img src="https://cdn-icons-png.flaticon.com/512/1063/1063191.png" class="h-8 w-8" alt="Logo"/>
      <h1 class="text-xl font-semibold">Shiptrack</h1>
    </div>
    <button id="themeToggle" class="p-2 rounded hover:bg-blue-700 dark:hover:bg-gray-700 transition">
      <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 116.707 2.707a.999.999 0 111.414 1.414A6 6 0 1016 10a.999.999 0 011.293 3.293z"/>
      </svg>
    </button>
  </header>

  <!-- NAVBAR -->
  <nav class="bg-blue-600 dark:bg-gray-700 text-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex justify-center space-x-4">
        <a href="#inicio" class="py-3 px-2 hover:bg-blue-500 dark:hover:bg-gray-600 rounded transition">Inicio</a>
        <a href="#busqueda" class="py-3 px-2 hover:bg-blue-500 dark:hover:bg-gray-600 rounded transition">BL</a>
        <a href="#simulador" class="py-3 px-2 hover:bg-blue-500 dark:hover:bg-gray-600 rounded transition">Simulador</a>
        <a href="#mapa" class="py-3 px-2 hover:bg-blue-500 dark:hover:bg-gray-600 rounded transition">Mapa</a>
        <a href="#contacto" class="py-3 px-2 hover:bg-blue-500 dark:hover:bg-gray-600 rounded transition">Contacto</a>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-4 space-y-6">

    <!-- SECCIÓN INICIO / BL -->
    <section id="inicio" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition">
      <h2 class="text-2xl font-bold mb-4">Buscar BL</h2>
      <div class="flex gap-4">
        <input id="blInput" type="text" placeholder="Número de BL" class="flex-1 p-3 border rounded bg-gray-50 dark:bg-gray-700"/>
        <button onclick="buscarBLPrincipal()" class="px-6 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded transition">Buscar</button>
      </div>
    </section>

    <!-- TABLA DE EVENTOS -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition">
      <h2 class="text-2xl font-bold mb-4">Eventos de Ruta</h2>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr>
            <th class="border-b p-2">Puerto / Evento</th>
            <th class="border-b p-2">Fecha</th>
            <th class="border-b p-2">Detalle</th>
          </tr>
        </thead>
        <tbody id="tablaEventos"></tbody>
      </table>
    </section>

    <!-- SIMULADOR -->
    <section id="simulador" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition seccion-oculta">
      <h2 class="text-2xl font-bold mb-4">Simulador de Carga</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select id="modo" class="p-3 border rounded bg-gray-50 dark:bg-gray-700">
          <option value="maritimo">Marítimo</option>
          <option value="aereo">Aéreo</option>
        </select>
        <input id="origen" type="text" placeholder="Origen" class="p-3 border rounded bg-gray-50 dark:bg-gray-700"/>
        <input id="destino" type="text" placeholder="Destino" class="p-3 border rounded bg-gray-50 dark:bg-gray-700"/>
        <input id="peso" type="number" placeholder="Peso (kg)" class="p-3 border rounded bg-gray-50 dark:bg-gray-700"/>
      </div>
      <button onclick="simularCarga()" class="mt-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded transition">Simular</button>
      <div id="simuladorResultado" class="mt-4"></div>
    </section>

    <!-- MAPA -->
    <section id="mapa" class="h-96 rounded-lg overflow-hidden shadow hover:shadow-lg transition"></section>

    <!-- CONTACTO -->
    <section id="contacto" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition seccion-oculta">
      <h2 class="text-2xl font-bold mb-4">Contacto</h2>
      <form onsubmit="enviarFormularioPrincipal(event)" class="space-y-4">
        <input id="nombre" type="text" placeholder="Nombre" class="w-full p-3 border rounded bg-gray-50 dark:bg-gray-700"/>
        <input id="email" type="email" placeholder="Correo" class="w-full p-3 border rounded bg-gray-50 dark:bg-gray-700"/>
        <textarea id="mensaje" rows="4" placeholder="Mensaje" class="w-full p-3 border rounded bg-gray-50 dark:bg-gray-700"></textarea>
        <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded transition">Enviar</button>
      </form>
    </section>

  </main>

  <!-- PANEL ESTADÍSTICAS -->
  <div id="panelEstadisticas" class="fixed bottom-6 left-6 w-80 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg transform translate-y-40 transition-transform">
    <button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" onclick="togglePanel()">&times;</button>
    <h3 class="text-lg font-semibold mb-4">Estadísticas</h3>
    <p>Cargas rastreadas: <span id="totalCargasPanel">0</span></p>
    <p>Tiempo tránsito: <span id="promedioTransitoPanel">-</span></p>
    <p>Dólar hoy: <span id="dolarHoy">–</span></p>
    <p>Cont. 20’: <span id="precio20">–</span>  Cont. 40’: <span id="precio40">–</span></p>
    <canvas id="chartRutas" class="mt-4"></canvas>
  </div>

  <!-- BOTONES FLOTANTES -->
  <button class="boton-flotante" onclick="togglePanel()"><i class="fas fa-chart-bar"></i></button>
  <button class="chatbot-button" onclick="toggleChat()"><i class="fas fa-robot"></i></button>

  <!-- CHATBOT -->
  <div id="chatWindow" class="fixed bottom-24 right-24 w-80 max-h-96 bg-white dark:bg-gray-800 rounded-lg shadow-lg hidden flex-col overflow-hidden">
    <div id="chatHeader" class="bg-blue-800 dark:bg-gray-700 text-white p-4 font-semibold">Ayuda Shiptrack</div>
    <div id="chatBody" class="p-4 overflow-y-auto flex flex-col space-y-2"></div>
    <div class="flex border-t dark:border-gray-700">
      <input id="chatInput" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border-none outline-none" placeholder="Escribe tu mensaje...">
      <button id="chatSend" class="px-4 bg-blue-600 hover:bg-blue-700 text-white">Enviar</button>
    </div>
  </div>

  <footer class="bg-blue-800 dark:bg-gray-800 text-white text-center p-4">© 2025 Shiptrack • Juan Giraldo & Dylan Díaz</footer>

  <script>
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.onclick = () => document.documentElement.classList.toggle('dark');

    // Initialize map
    const map = L.map('mapa').setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(map);
    let polyline, markers = [], cargas = 0;

    // BL functions
    function resetMapAndTable() {
      document.getElementById("tablaEventos").innerHTML = "";
      markers.forEach(m=>map.removeLayer(m));
      if(polyline) map.removeLayer(polyline);
      markers=[];
    }
    function drawRoute(ruta) {
      const coords=[];
      ruta.forEach(p=>{
        const m = L.marker(p.coords).addTo(map).bindPopup(`<strong>${p.nombre}</strong><br>${p.tiempo}`);
        markers.push(m);
        coords.push(p.coords);
        const row=document.getElementById("tablaEventos").insertRow();
        row.insertCell(0).textContent = p.nombre;
        row.insertCell(1).textContent = p.tiempo;
        row.insertCell(2).textContent = "-";
      });
      if(coords.length>1){
        polyline=L.polyline(coords,{color:'blue'}).addTo(map);
        map.fitBounds(polyline.getBounds());
      } else map.setView(coords[0],5);
    }
    function buscarBLPrincipal() {
      const bl=document.getElementById("blInput").value.trim();
      if(!bl||bl.length<6) return alert("BL inválido.");
      resetMapAndTable();
      let ruta=[];
      if(bl==="MEDUQT871264"){
        ruta=[
          {nombre:"Qingdao - Cargado",coords:[36.0671,120.3826],tiempo:"17 feb 2025"},
          {nombre:"Busan - Transbordo",coords:[35.1796,129.0756],tiempo:"22-23 feb 2025"},
          {nombre:"Buenaventura - Descarga",coords:[3.8801,-77.0312],tiempo:"25 mar 2025"}
        ];
      } else if(bl==="250339340"){
        ruta=[
          {nombre:"Shanghai - Vacío",coords:[31.2304,121.4737],tiempo:"24 feb 2025"},
          {nombre:"Salida buque",coords:[31.2304,121.4737],tiempo:"6 mar 2025"},
          {nombre:"Buenaventura - Llegada",coords:[3.8801,-77.0312],tiempo:"3 abr 2025"}
        ];
      } else return alert("BL no reconocido.");
      drawRoute(ruta);
      cargas++; actualizarEstadisticas();
    }
    function buscarBLSecundario(){
      const bl=document.getElementById("blNumber").value.trim();
      document.getElementById("blInput").value=bl;
      buscarBLPrincipal(); return false;
    }

    // Geocode & distance
    async function geocode(place){
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
      const d=await res.json();
      if(!d.length) throw new Error("Ubicación no encontrada: "+place);
      return [parseFloat(d[0].lat),parseFloat(d[0].lon)];
    }
    function haversine([la1,lo1],[la2,lo2]){
      const R=6371,dLat=(la2-la1)*Math.PI/180,dLon=(lo2-lo1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    // Simulator
    async function simularCarga(){
      const modo=document.getElementById("modo").value;
      const origen=document.getElementById("origen").value.trim();
      const destino=document.getElementById("destino").value.trim();
      const peso=parseFloat(document.getElementById("peso").value);
      const resDiv=document.getElementById("simuladorResultado");
      if(!origen||!destino||isNaN(peso)||peso<=0) return void(resDiv.textContent="Datos inválidos.");
      resDiv.textContent="Calculando…";
      try{
        const c1=await geocode(origen),c2=await geocode(destino);
        const dist=haversine(c1,c2).toFixed(1);
        resetMapAndTable();
        markers.push(L.marker(c1).addTo(map).bindPopup(origen));
        markers.push(L.marker(c2).addTo(map).bindPopup(destino));
        polyline=L.polyline([c1,c2],{color:modo==='aereo'?'red':'green'}).addTo(map);
        map.fitBounds(polyline.getBounds(),{padding:[50,50]});
        const rate=modo==='aereo'?0.05:0.002;
        const costo=(dist*peso*rate).toFixed(2);
        resDiv.innerHTML=`
          <h3>Simulación (${modo})</h3>
          <ul>
            <li>Distancia: ${dist} km</li>
            <li>Peso: ${peso} kg</li>
            <li>Tarifa: $${rate} USD/(kg·km)</li>
          </ul>
          <h3>Costo: $${costo} USD</h3>
        `;
      }catch(e){ resDiv.textContent=e.message; }
    }

    // User & contact
    function iniciarSesion(){
      const u=document.getElementById("usuarioNombre").value,p=document.getElementById("usuarioClave").value;
      document.getElementById("usuarioMensaje").textContent=(u==='admin'&&p==='1234')?'Éxito.':'Credenciales inválidas.';
    }
    function enviarFormularioPrincipal(e){
      e.preventDefault();
      alert(`Gracias, ${document.getElementById("nombre").value}. Te responderemos pronto.`);
      e.target.reset();
    }

    // Stats & containers
    async function cargarDolarHoy(){
      try{
        const r=await fetch('https://api.exchangerate.host/latest?base=USD&symbols=COP'),
              j=await r.json();
        document.getElementById('dolarHoy').textContent=`1 USD = ${j.rates.COP.toFixed(2)} COP`;
      }catch{ document.getElementById('dolarHoy').textContent='Error'; }
    }
    function cargarPreciosContenedores(){
      document.getElementById('precio20').textContent='$2 500 USD';
      document.getElementById('precio40').textContent='$4 200 USD';
    }
    function togglePanel(){
      const p=document.getElementById("panelEstadisticas");
      p.classList.toggle("activo");
      if(p.classList.contains("activo")){
        cargarDolarHoy(); cargarPreciosContenedores();
        updateChart();
      }
    }
    function actualizarEstadisticas(){
      document.getElementById("totalCargasPanel").textContent=cargas;
      document.getElementById("promedioTransitoPanel").textContent='25–35 días';
    }
    document.addEventListener('click',e=>{
      const panel=document.getElementById("panelEstadisticas"),
            btn=document.querySelector(".boton-flotante");
      if(panel.classList.contains("activo")&&!panel.contains(e.target)&&!btn.contains(e.target))
        panel.classList.remove("activo");
    });

    // Navigation
    document.querySelectorAll('nav a').forEach(link=>{
      link.addEventListener('click',e=>{
        e.preventDefault();
        document.querySelectorAll('main > section').forEach(s=>s.classList.add('seccion-oculta'));
        const id=link.getAttribute('href').substring(1);
        document.getElementById(id).classList.remove('seccion-oculta');
      });
    });

    // Chart.js for routes
    let chart;
    function initChart(){
      const ctx=document.getElementById('chartRutas').getContext('2d');
      chart=new Chart(ctx,{type:'bar',data:{
        labels:['Shanghai','Qingdao→Busan','Buenaventura'],
        datasets:[{label:'Veces rastreadas',data:[5,3,8],backgroundColor:'rgba(59,130,246,0.7)'}]
      },options:{responsive:true,plugins:{legend:{display:false}}}});
    }
    function updateChart(){
      if(chart) chart.update();
    }

    // Chatbot
    const chatWindow=document.getElementById('chatWindow'),
          chatBody=document.getElementById('chatBody'),
          chatInput=document.getElementById('chatInput'),
          chatSend=document.getElementById('chatSend');
    let showedInitial=false;
    function toggleChat(){
      if(chatWindow.style.display==='flex') chatWindow.style.display='none';
      else {
        chatWindow.style.display='flex';
        if(!showedInitial){
          showedInitial=true;
          ['¡Bienvenido a Shiptrack!','- Crear cuenta: pestaña "Mi Cuenta".','- Buscar BL: pestaña "BL".','- Simulador: pestaña "Simulador".','- Estadísticas: botón flotante.']
          .forEach(m=>appendMessage(m,'bot'));
        }
      }
    }
    function appendMessage(text,s){
      const m=document.createElement('div');
      m.classList.add('chat-message',s==='user'?'chat-user':'chat-bot');
      m.textContent=text; chatBody.appendChild(m); chatBody.scrollTop=chatBody.scrollHeight;
    }
    chatSend.addEventListener('click',()=>{
      const t=chatInput.value.trim(); if(!t)return;
      appendMessage(t,'user'); chatInput.value='';
      setTimeout(()=>{
        let r;if(/crear cuenta|registro/.test(t.toLowerCase())) r='Ve a "Mi Cuenta" e inicia sesión.';
        else if(/bl|conocimiento/.test(t.toLowerCase())) r='Usa sección "BL" con tu número completo.';
        else if(/simulador/.test(t.toLowerCase())) r='Selecciona modo, origen, destino, peso y Simular.';
        else if(/estadística|dólar|contenedor/.test(t.toLowerCase())) r='Panel muestra búsquedas, dólar y precios contenedores.';
        else if(/hola|buenos/.test(t.toLowerCase())) r='¡Hola! ¿Cómo puedo ayudarte?';
        else r='No entendí. Prueba: crear cuenta, BL, simulador, estadísticas.';
        appendMessage(r,'bot');
      },300);
    });
    chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();chatSend.click();}});

    // Init on load
    window.addEventListener('DOMContentLoaded',()=>{
      initChart();
      actualizarEstadisticas();
    });
  </script>
</body>
</html>
