<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shiptrack - Seguimiento de Carga</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4 }
    header { background:#003366; color:#fff; padding:15px; text-align:center }
    nav { background:#002244; padding:10px; display:flex; justify-content:center; gap:20px }
    nav a { color:#fff; text-decoration:none; font-weight:bold }
    nav a:hover { text-decoration:underline }
    .contenedor { max-width:1000px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); text-align:center }
    .seccion-oculta { display:none }
    input, button, textarea, select { width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:4px }
    button { background:#003366; color:#fff; border:none; cursor:pointer }
    button:hover { background:#002244 }
    #mapa { margin:20px auto; width:90%; height:500px }
    table { width:90%; margin:20px auto; background:#fff; border-collapse:collapse }
    th, td { border:1px solid #ddd; padding:8px }
    th { background:#003366; color:#fff }
    footer { text-align:center; padding:10px; background:#003366; color:#fff; margin-top:30px }

    .formulario-contacto { background:#fff; padding:20px; margin:30px auto; border-radius:8px; max-width:600px }
    .boton-flotante { position:fixed; bottom:20px; right:20px; background:#003366; color:#fff; border:none; border-radius:50%; width:60px; height:60px; font-size:24px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3); z-index:1000; transition:0.3s }
    .boton-flotante:hover { background:#005599; transform:scale(1.1) }
    #panelEstadisticas { position:fixed; bottom:90px; right:20px; width:320px; background:#fff; border-radius:10px; padding:15px; box-shadow:0 4px 10px rgba(0,0,0,0.2); display:none; z-index:999; opacity:0; transform:translateY(10px); transition:0.3s }
    #panelEstadisticas.activo { display:block; opacity:1; transform:translateY(0) }
    #panelEstadisticas .cerrar-panel { background:none; border:none; font-size:20px; position:absolute; top:8px; right:10px; cursor:pointer; color:#888 }
    #panelEstadisticas .cerrar-panel:hover { color:#333 }

    /* Chatbot */
    .chatbot-button { position:fixed; bottom:20px; right:100px; background:#0077cc; color:#fff; border:none; border-radius:50%; width:60px; height:60px; font-size:24px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3); z-index:1000; transition:0.3s }
    .chatbot-button:hover { background:#005fa3; transform:scale(1.1) }
    #chatWindow { position:fixed; bottom:90px; right:100px; width:320px; max-height:450px; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); display:none; flex-direction:column; overflow:hidden; z-index:1000 }
    #chatHeader { background:#003366; color:#fff; padding:10px; font-weight:bold }
    #chatBody { flex:1; padding:10px; overflow-y:auto; background:#f9f9f9; display:flex; flex-direction:column }
    .chat-message { margin:5px 0; padding:8px; border-radius:4px; max-width:80%; word-wrap:break-word }
    .chat-user { background:#d1e7fd; align-self:flex-end }
    .chat-bot  { background:#e5e5e5; align-self:flex-start }
    #chatInputContainer { display:flex; border-top:1px solid #ddd }
    #chatInput { flex:1; border:none; padding:10px; outline:none }
    #chatSend { background:#003366; color:#fff; border:none; padding:0 16px; cursor:pointer }
  </style>
</head>
<body>
  <header>
    <h1>Shiptrack - Seguimiento de Carga</h1>
    <p>Seguimiento de carga marítima en tiempo real</p>
  </header>

  <nav>
    <a href="#inicio">Inicio</a>
    <a href="#busqueda">BL</a>
    <a href="#simulador">Simulador</a>
    <a href="#mapa">Mapa</a>
    <a href="#usuario">Usuario</a>
    <a href="#contacto">Contacto</a>
    <a href="#ayuda">Ayuda</a>
    <a href="#cuenta">Mi Cuenta</a>
  </nav>

  <div id="inicio" class="contenedor">
    <input type="text" id="blInput" placeholder="Ingrese su número de BL" required>
    <button onclick="buscarBLPrincipal()">Buscar</button>
  </div>

  <div id="busqueda" class="contenedor seccion-oculta">
    <h2>Buscar conocimiento de embarque (BL)</h2>
    <form onsubmit="return buscarBLSecundario();">
      <input type="text" id="blNumber" placeholder="Ingresa el número BL" required>
      <button type="submit"><i class="fas fa-search"></i> Buscar</button>
    </form>
    <div id="resultContainer">Introduce un número BL para ver resultados aquí.</div>
  </div>

  <div id="mapa"></div>

  <table>
    <thead>
      <tr><th>Puerto / Evento</th><th>Fecha / Tránsito</th><th>Detalle</th></tr>
    </thead>
    <tbody id="tablaEventos"></tbody>
  </table>

  <div id="simulador" class="contenedor seccion-oculta">
    <h2>Simulador de carga dinámico</h2>
    <form onsubmit="simularCarga(); return false;">
      <select id="modo" required>
        <option value="maritimo">Marítimo</option>
        <option value="aereo">Aéreo</option>
      </select>
      <input type="text" id="origen" placeholder="Origen (ciudad, puerto o país)" required>
      <input type="text" id="destino" placeholder="Destino (ciudad, puerto o país)" required>
      <input type="number" id="peso" placeholder="Peso estimado (kg)" required>
      <button type="submit">Simular</button>
    </form>
    <div id="simuladorResultado"></div>
  </div>

  <div id="usuario" class="contenedor seccion-oculta">
    <h2>Área de Usuario</h2>
    <form onsubmit="iniciarSesion(); return false;">
      <input type="text" id="usuarioNombre" placeholder="Usuario" required>
      <input type="password" id="usuarioClave" placeholder="Contraseña" required>
      <button type="submit">Iniciar sesión</button>
    </form>
    <div id="usuarioMensaje"></div>
  </div>

  <div id="contacto" class="formulario-contacto seccion-oculta">
    <h2>Contacto</h2>
    <form onsubmit="enviarFormularioPrincipal(event);">
      <input type="text" id="nombre" placeholder="Tu nombre" required>
      <input type="email" id="email" placeholder="Tu correo electrónico" required>
      <textarea id="mensaje" rows="5" placeholder="Tu mensaje o duda" required></textarea>
      <button type="submit">Enviar mensaje</button>
    </form>
    <p>O escríbenos a <strong>soporte@shiptrack.com</strong> o por <a href="https://wa.me/1234567890" target="_blank">WhatsApp</a></p>
  </div>

  <div id="ayuda" class="contenedor seccion-oculta">
    <h2>Ayuda</h2>
    <p>Preguntas frecuentes e información de uso.</p>
  </div>

  <div id="cuenta" class="contenedor seccion-oculta">
    <h2>Mi Cuenta</h2>
    <p>Funcionalidad futura: guarda BL, notificaciones, etc.</p>
  </div>

  <div id="panelEstadisticas">
    <button class="cerrar-panel" onclick="togglePanel()">&times;</button>
    <h3><i class="fas fa-chart-bar"></i> Estadísticas</h3>
    <p>Cargas rastreadas: <span id="totalCargasPanel">0</span></p>
    <p>Rutas comunes:</p>
    <ul id="rutasComunesPanel"></ul>
    <p>Tiempo promedio tránsito: <span id="promedioTransitoPanel">-</span></p>
    <p>Cotización USD (hoy): <span id="dolarHoy">Cargando…</span></p>
    <p>Precio contenedor 20’: <span id="precio20">Cargando…</span></p>
    <p>Precio contenedor 40’: <span id="precio40">Cargando…</span></p>
  </div>

  <button class="boton-flotante" onclick="togglePanel()"><i class="fas fa-chart-bar"></i></button>
  <button class="chatbot-button" onclick="toggleChat()"><i class="fas fa-robot"></i></button>

  <div id="chatWindow">
    <div id="chatHeader">Ayuda de Shiptrack</div>
    <div id="chatBody"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." />
      <button id="chatSend">Enviar</button>
    </div>
  </div>

  <footer>
    &copy; 2025 Shiptrack | Desarrollado por Juan Giraldo y Dylan Díaz.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // Mapa
    const map = L.map('mapa').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let polyline, markers = [], cargas = 0;

    // BL
    function buscarBLPrincipal() {
      const bl = document.getElementById("blInput").value.trim();
      if (!bl || bl.length < 6) return alert("BL inválido (mínimo 6 caracteres).");
      resetMapAndTable();
      let ruta = [];
      if (bl === "MEDUQT871264") {
        ruta = [
          { nombre: "Qingdao - Cargado", coords: [36.0671,120.3826], tiempo: "17 feb 2025" },
          { nombre: "Busan - Transbordo", coords: [35.1796,129.0756], tiempo: "22-23 feb 2025" },
          { nombre: "Buenaventura - Descarga", coords: [3.8801,-77.0312], tiempo: "25 mar 2025" }
        ];
      } else if (bl === "250339340") {
        ruta = [
          { nombre: "Shanghai - Vacío", coords: [31.2304,121.4737], tiempo: "24 feb 2025" },
          { nombre: "Salida buque", coords: [31.2304,121.4737], tiempo: "6 mar 2025" },
          { nombre: "Buenaventura - Llegada", coords: [3.8801,-77.0312], tiempo: "3 abr 2025" }
        ];
      } else {
        return alert("BL no reconocido.");
      }
      drawRoute(ruta);
      cargas++; actualizarEstadisticas();
    }
    function buscarBLSecundario() {
      const bl = document.getElementById("blNumber").value.trim();
      document.getElementById("blInput").value = bl;
      buscarBLPrincipal();
      return false;
    }
    function resetMapAndTable() {
      document.getElementById("tablaEventos").innerHTML = "";
      markers.forEach(m => map.removeLayer(m));
      if (polyline) map.removeLayer(polyline);
      markers = [];
    }
    function drawRoute(ruta) {
      const coords = [];
      ruta.forEach(p => {
        const m = L.marker(p.coords).addTo(map).bindPopup(`<strong>${p.nombre}</strong><br>${p.tiempo}`);
        markers.push(m);
        coords.push(p.coords);
        const row = document.getElementById("tablaEventos").insertRow();
        row.insertCell(0).textContent = p.nombre;
        row.insertCell(1).textContent = p.tiempo;
        row.insertCell(2).textContent = "-";
      });
      if (coords.length > 1) {
        polyline = L.polyline(coords, { color: 'blue' }).addTo(map);
        map.fitBounds(polyline.getBounds());
      } else {
        map.setView(coords[0], 5);
      }
    }

    // Geocoding + distancia
    async function geocode(place) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
      const data = await res.json();
      if (!data.length) throw new Error('Ubicación no encontrada: ' + place);
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }
    function haversine([lat1,lon1],[lat2,lon2]) {
      const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Simulador
    async function simularCarga() {
      const modo    = document.getElementById("modo").value;
      const origen  = document.getElementById("origen").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const peso    = parseFloat(document.getElementById("peso").value);
      const resDiv  = document.getElementById("simuladorResultado");
      if (!origen||!destino||isNaN(peso)||peso<=0) {
        return void(resDiv.textContent = 'Por favor ingresa datos válidos.');
      }
      resDiv.textContent = 'Calculando…';
      try {
        const c1 = await geocode(origen), c2 = await geocode(destino);
        const dist = haversine(c1, c2).toFixed(1);
        resetMapAndTable();
        markers.push(L.marker(c1).addTo(map).bindPopup(origen));
        markers.push(L.marker(c2).addTo(map).bindPopup(destino));
        polyline = L.polyline([c1, c2], { color: modo==='aereo'?'red':'green' }).addTo(map);
        map.fitBounds(polyline.getBounds(), { padding: [50,50] });
        const rate = modo==='aereo'?0.05:0.002;
        const costo = (dist * peso * rate).toFixed(2);
        resDiv.innerHTML = `
          <h3>Simulación (${modo})</h3>
          <ul>
            <li><b>Distancia:</b> ${dist} km</li>
            <li><b>Peso:</b> ${peso} kg</li>
            <li><b>Tarifa:</b> $${rate} USD/(kg·km)</li>
          </ul>
          <h3>Costo estimado: $${costo} USD</h3>
        `;
      } catch (e) {
        resDiv.textContent = e.message;
      }
    }

    // Usuario y contacto
    function iniciarSesion() {
      const u = document.getElementById("usuarioNombre").value;
      const p = document.getElementById("usuarioClave").value;
      document.getElementById("usuarioMensaje").textContent =
        (u==='admin'&&p==='1234')?'Inicio exitoso.':'Usuario o contraseña incorrecta.';
    }
    function enviarFormularioPrincipal(e) {
      e.preventDefault();
      const n = document.getElementById("nombre").value;
      alert(`Gracias por contactarnos, ${n}. Te responderemos pronto.`);
      e.target.reset();
    }

    // Estadísticas y contenedores
    async function cargarDolarHoy() {
      try {
        const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=COP');
        const json = await res.json();
        document.getElementById('dolarHoy').textContent = `1 USD = ${json.rates.COP.toFixed(2)} COP`;
      } catch {
        document.getElementById('dolarHoy').textContent = 'Error';
      }
    }
    function cargarPreciosContenedores() {
      document.getElementById('precio20').textContent = '$2 500 USD';
      document.getElementById('precio40').textContent = '$4 200 USD';
    }
    function togglePanel() {
      const p = document.getElementById("panelEstadisticas");
      p.classList.toggle("activo");
      if (p.classList.contains("activo")) {
        cargarDolarHoy();
        cargarPreciosContenedores();
      }
    }
    function actualizarEstadisticas() {
      document.getElementById("totalCargasPanel").textContent = cargas;
      const ul = document.getElementById("rutasComunesPanel"); ul.innerHTML = '';
      ['Shanghai – Buenaventura','Qingdao – Busan – Buenaventura'].forEach(r => {
        const li = document.createElement('li'); li.textContent = r; ul.appendChild(li);
      });
      document.getElementById("promedioTransitoPanel").textContent = '25–35 días';
    }
    document.addEventListener('click', e => {
      const panel = document.getElementById("panelEstadisticas");
      const btn   = document.querySelector(".boton-flotante");
      if (panel.classList.contains("activo") && !panel.contains(e.target) && !btn.contains(e.target)) {
        panel.classList.remove("activo");
      }
    });

    // Navegación secciones
    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.contenedor, .formulario-contacto').forEach(s => s.classList.add('seccion-oculta'));
        const id = link.getAttribute('href').substring(1);
        const sec = document.getElementById(id);
        if (sec) {
          sec.classList.remove('seccion-oculta');
          window.scrollTo({ top: sec.offsetTop - 50, behavior: 'smooth' });
        }
      });
    });

    // Chatbot
    const chatWindow = document.getElementById('chatWindow');
    const chatBody   = document.getElementById('chatBody');
    const chatInput  = document.getElementById('chatInput');
    const chatSend   = document.getElementById('chatSend');
    let showedInitial = false;
    function toggleChat() {
      if (chatWindow.style.display === 'flex') {
        chatWindow.style.display = 'none';
      } else {
        chatWindow.style.display = 'flex';
        if (!showedInitial) {
          showedInitial = true;
          ['¡Bienvenido a Shiptrack! Aquí tienes ayuda:','- Crear cuenta: pestaña "Mi Cuenta".','- Buscar BL: pestaña "BL".','- Simulador: pestaña "Simulador".','- Estadísticas: botón flotante.']
          .forEach(msg => appendMessage(msg,'bot'));
        }
      }
    }
    function appendMessage(text,sender) {
      const msg = document.createElement('div');
      msg.classList.add('chat-message', sender==='user'?'chat-user':'chat-bot');
      msg.textContent = text;
      chatBody.appendChild(msg);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    chatSend.addEventListener('click',()=>{
      const txt=chatInput.value.trim(); if(!txt) return;
      appendMessage(txt,'user'); chatInput.value='';
      setTimeout(()=>{
        let r;
        const t=txt.toLowerCase();
        if(/crear cuenta|registro/.test(t)) r='Ve a "Mi Cuenta" e inicia sesión o regístrate.';
        else if(/bl|conocimiento/.test(t)) r='En "BL" ingresa tu número completo para ver ruta.';
        else if(/simulador/.test(t)) r='Selecciona modo, origen, destino, peso y clic en Simular.';
        else if(/estadística|dólar|contenedor/.test(t)) r='El panel muestra búsquedas, dólar hoy y precios 20’/40’.';
        else if(/hola|buenos/.test(t)) r='¡Hola! ¿Cómo puedo ayudarte?';
        else r='No entendí. Usa: crear cuenta, BL, simulador, estadísticas.';
        appendMessage(r,'bot');
      },300);
    });
    chatInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'){e.preventDefault();chatSend.click();}
    });

    // Inicial
    actualizarEstadisticas();
  </script>
</body>
</html>
