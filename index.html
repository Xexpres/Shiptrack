<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shiptrack - Seguimiento de Carga</title>
  <!-- Favicon -->
  <link rel="icon" href="assets/logo-dark.png" type="image/png"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors">

  <!-- HEADER -->
  <header class="bg-blue-800 dark:bg-gray-800 text-white p-4 flex justify-between items-center">
    <div class="flex items-center space-x-3">
      <img src="assets/logo-dark.png" class="h-10 w-10" alt="Logo"/>
      <h1 class="text-xl font-semibold">Shiptrack</h1>
    </div>
    <button id="themeToggle" class="p-2 rounded hover:bg-blue-700 dark:hover:bg-gray-700">
      <i class="fas fa-moon" id="themeIcon"></i>
    </button>
  </header>

  <!-- NAV -->
  <nav class="bg-blue-600 dark:bg-gray-700 text-white">
    <div class="max-w-4xl mx-auto px-4">
      <div class="flex justify-center space-x-4">
        <a href="#inicio" class="py-3 px-2 hover:bg-blue-500 rounded">Inicio</a>
        <a href="#simulador" class="py-3 px-2 hover:bg-blue-500 rounded">Simulador</a>
        <a href="#contacto" class="py-3 px-2 hover:bg-blue-500 rounded">Contacto</a>
      </div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto p-4 space-y-6">

    <!-- INICIO / BL -->
    <section id="inicio" class="bg-white dark:bg-gray-800 p-6 rounded shadow relative">
      <h2 class="text-2xl font-bold mb-4">Buscar BL</h2>
      <form class="flex gap-4" onsubmit="return buscarBL();">
        <div class="relative flex-1">
          <input id="blNumber" type="text" placeholder=" " required minlength="6"
                 class="peer w-full border-b-2 border-gray-300 bg-transparent py-2 px-0 focus:outline-none"/>
          <label for="blNumber"
                 class="absolute left-0 -top-3.5 text-gray-500 text-sm transition-all
                        peer-placeholder-shown:top-2 peer-placeholder-shown:text-base peer-focus:-top-3.5">
            Número de BL
          </label>
        </div>
        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
          <i class="fas fa-search"></i>
        </button>
      </form>
      <button onclick="toggleHist()" class="absolute top-6 right-6 p-2 bg-gray-200 rounded-full hover:bg-gray-300">
        <i class="fas fa-history"></i>
      </button>
      <div id="histPanel" class="absolute top-16 right-6 w-48 max-h-48 overflow-auto bg-white dark:bg-gray-800 border hidden">
        <ul id="histList"></ul>
      </div>
    </section>

    <!-- MAPA -->
    <div id="mapa" class="h-64 rounded shadow"></div>

    <!-- EVENTOS -->
    <section class="bg-white dark:bg-gray-800 p-4 rounded shadow">
      <h3 class="text-xl mb-2 font-bold">Eventos de Ruta</h3>
      <table class="w-full text-left">
        <thead>
          <tr>
            <th class="border-b p-1">Evento</th>
            <th class="border-b p-1">Fecha</th>
          </tr>
        </thead>
        <tbody id="tablaEventos"></tbody>
      </table>
    </section>

    <!-- SIMULADOR -->
    <section id="simulador" class="bg-white dark:bg-gray-800 p-6 rounded shadow hidden">
      <h2 class="text-2xl font-bold mb-4">Simulador de Carga</h2>
      <form onsubmit="simularCarga(); return false;" class="space-y-4">
        <div class="relative">
          <select id="modo" class="peer w-full border-b-2 border-gray-300 bg-transparent py-2 px-0 focus:outline-none" required>
            <option value="maritimo">Marítimo</option>
            <option value="aereo">Aéreo</option>
          </select>
          <label for="modo" class="absolute left-0 -top-3.5 text-gray-500 text-sm transition-all peer-focus:-top-3.5">
            Modo de Transporte
          </label>
        </div>
        <div class="relative">
          <input id="origen" type="text" placeholder=" " required
                 class="peer w-full border-b-2 border-gray-300 bg-transparent py-2 px-0 focus:outline-none"/>
          <label for="origen" class="absolute left-0 -top-3.5 text-gray-500 text-sm transition-all peer-focus:-top-3.5">
            Origen
          </label>
        </div>
        <div class="relative">
          <input id="destino" type="text" placeholder=" " required
                 class="peer w-full border-b-2 border-gray-300 bg-transparent py-2 px-0 focus:outline-none"/>
          <label for="destino" class="absolute left-0 -top-3.5 text-gray-500 text-sm transition-all peer-focus:-top-3.5">
            Destino
          </label>
        </div>
        <div class="relative">
          <input id="peso" type="number" min="1" placeholder=" " required
                 class="peer w-full border-b-2 border-gray-300 bg-transparent py-2 px-0 focus:outline-none"/>
          <label for="peso" class="absolute left-0 -top-3.5 text-gray-500 text-sm transition-all peer-focus:-top-3.5">
            Peso (kg)
          </label>
        </div>
        <button type="submit" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded">
          Simular
        </button>
      </form>
      <div id="simuladorResultado" class="mt-4"></div>
    </section>

    <!-- CONTACTO -->
    <section id="contacto" class="bg-white dark:bg-gray-800 p-6 rounded shadow hidden">
      <h2 class="text-2xl font-bold mb-4">Contacto</h2>
      <form onsubmit="enviarContacto(event)" class="space-y-4">
        <!-- Tu formulario de contacto aquí -->
      </form>
    </section>

  </main>

  <!-- ESTADÍSTICAS -->
  <div id="panelEstadisticas" class="fixed bottom-6 left-6 w-64 bg-white dark:bg-gray-800 p-4 rounded shadow hidden">
    <button class="absolute top-2 right-2" onclick="toggleStats()">×</button>
    <h4 class="font-semibold mb-2">Estadísticas</h4>
    <p>BL rastreados: <span id="countBL">0</span></p>
    <p>TRM (USD→COP): <span id="trm">Cargando…</span></p>
    <canvas id="chart" class="mt-2"></canvas>
  </div>
  <button id="btnStats" class="fixed bottom-6 right-6 bg-blue-600 text-white p-3 rounded-full shadow" onclick="toggleStats()">
    <i class="fas fa-chart-bar"></i>
  </button>

  <footer class="bg-blue-800 dark:bg-gray-800 text-white text-center p-4">
    © 2025 Shiptrack
  </footer>

  <script>
    // Tema
    const btnTheme = document.getElementById('themeToggle'),
          iconTheme = document.getElementById('themeIcon');
    btnTheme.onclick = () => {
      document.documentElement.classList.toggle('dark');
      iconTheme.classList.toggle('fa-sun');
      iconTheme.classList.toggle('fa-moon');
    };

    // Navegación
    document.querySelectorAll('nav a').forEach(link => {
      link.onclick = e => {
        e.preventDefault();
        document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden'));
        document.getElementById(link.getAttribute('href').slice(1)).classList.remove('hidden');
      }
    });

    // Mapa
    const map = L.map('mapa').setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [], poly;

    function resetRoute() {
      markers.forEach(m=>map.removeLayer(m));
      markers = [];
      if(poly) map.removeLayer(poly);
      document.getElementById('tablaEventos').innerHTML = '';
    }

    // Buscar BL
    function buscarBL() {
      const bl = document.getElementById('blNumber').value.trim();
      if(bl.length < 6) return false;
      // Historial
      const h = JSON.parse(localStorage.getItem('hist')||'[]');
      h.push(bl);
      localStorage.setItem('hist', JSON.stringify(h));

      resetRoute();
      let ruta = [];
      if(bl === 'MEDUQT871264') {
        ruta = [
          {nombre:'Qingdao - Cargado',coords:[36.0671,120.3826],tiempo:'17 feb 2025'},
          {nombre:'Busan - Transbordo',coords:[35.1796,129.0756],tiempo:'22-23 feb 2025'},
          {nombre:'Buenaventura - Descarga',coords:[3.8801,-77.0312],tiempo:'25 mar 2025'}
        ];
      } else if(bl === '250339340') {
        ruta = [
          {nombre:'Shanghai - Vacío',coords:[31.2304,121.4737],tiempo:'24 feb 2025'},
          {nombre:'Salida buque',coords:[31.2304,121.4737],tiempo:'6 mar 2025'},
          {nombre:'Buenaventura - Llegada',coords:[3.8801,-77.0312],tiempo:'3 abr 2025'}
        ];
      } else {
        alert('BL no reconocido');
        return false;
      }

      ruta.forEach(pt => {
        const mk = L.marker(pt.coords).addTo(map).bindPopup(`${pt.nombre}<br>${pt.tiempo}`);
        markers.push(mk);
        const row = document.getElementById('tablaEventos').insertRow();
        row.insertCell(0).textContent = pt.nombre;
        row.insertCell(1).textContent = pt.tiempo;
      });
      const latlngs = ruta.map(pt=>pt.coords);
      if(latlngs.length > 1) {
        poly = L.polyline(latlngs,{color:'blue'}).addTo(map);
        map.fitBounds(poly.getBounds());
      }
      document.getElementById('countBL').textContent = markers.length ? 1 : 0;
      return false;
    }

    // Historial
    function toggleHist() {
      const p = document.getElementById('histPanel'),
            ul = document.getElementById('histList');
      p.classList.toggle('hidden');
      if(!p.classList.contains('hidden')) {
        ul.innerHTML = '';
        const codes = [...new Set(JSON.parse(localStorage.getItem('hist')||'[]').reverse())];
        codes.forEach(c => {
          const li = document.createElement('li');
          li.textContent = c;
          li.className = 'p-2 hover:bg-gray-200 cursor-pointer';
          li.onclick = () => {
            document.getElementById('blNumber').value = c;
            toggleHist();
            buscarBL();
          };
          ul.appendChild(li);
        });
      }
    }

    // Simulador placeholder (implementar según necesites)...

    // Estadísticas y TRM from Banco de la República
    async function cargarTRM() {
      try {
        const res = await fetch('https://www.datos.gov.co/resource/5a63-8mx9.json?$select=valor&$order=fecha%20desc&$limit=1');
        const json = await res.json();
        document.getElementById('trm').textContent = parseFloat(json[0].valor).toFixed(2) + ' COP';
      } catch {
        document.getElementById('trm').textContent = 'Error';
      }
    }
    function toggleStats() {
      const panel = document.getElementById('panelEstadisticas');
      panel.classList.toggle('hidden');
      if(!panel.classList.contains('hidden')) {
        cargarTRM();
        // Iniciar o actualizar tu gráfico también aquí...
      }
    }
    document.getElementById('btnStats').onclick = toggleStats;

  </script>
</body>
</html>
