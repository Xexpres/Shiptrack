<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shiptrack - Seguimiento de carga</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f4;
  text-align: center;
}
header {
  background-color: #003366;
  color: white;
  padding: 15px;
}
.contenedor {
  max-width: 600px;
  margin: 20px auto;
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
input, button {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border: 1px solid #ddd;
  border-radius: 4px;
}
button {
  background-color: #003366;
  color: white;
  border: none;
  cursor: pointer;
}
button:hover {
  background-color: #002244;
}
.mapa-contenedor {
  margin: 20px auto;
  width: 90%;
  height: 500px;
}
.tabla-info {
  width: 90%;
  margin: 20px auto;
  background-color: white;
  border-collapse: collapse;
}
.tabla-info th, .tabla-info td {
  border: 1px solid #ddd;
  padding: 8px;
}
.tabla-info th {
  background-color: #003366;
  color: white;
}
footer {
  text-align: center;
  padding: 10px;
  background-color: #003366;
  color: white;
  position: fixed;
  bottom: 0;
  width: 100%;
}
#imageContainer {
  margin-top: 20px;
  text-align: center;
}
#imageContainer img {
  max-width: 100%;
  height: auto;
  margin-top: 20px;
}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<header>
  Shiptrack - Seguimiento de carga
</header>

<div class="contenedor">
  <input type="text" id="username" placeholder="Ingrese su nombre de usuario">
  <input type="text" id="blNumber" placeholder="Ingrese su número de conocimiento de embarque">
  <button type="button" onclick="buscarBL()">Buscar</button>
  <button type="button" onclick="mostrarHistorialCompleto()">Ver todo el historial</button>
  <button type="button" onclick="mostrarAyuda()">Ayuda</button>
  <input type="file" id="imageInput" accept="image/*" onchange="mostrarImagen(event)">
</div>

<div id="mapa" class="mapa-contenedor"></div>

<table class="tabla-info">
  <thead>
    <tr>
      <th>Puerto</th>
      <th>Evento</th>
      <th>Fecha</th>
    </tr>
  </thead>
  <tbody id="puertoTiempos"></tbody>
</table>

<div id="historialBusqueda" class="contenedor"></div>

<div id="imageContainer"></div>

<footer>
  <p>&copy; 2025 Shiptrack | Desarrollado por Juan Giraldo y Dylan Díaz</p>
</footer>

<script>
function buscarBL() {
  var bl = document.getElementById("blNumber").value.trim();
  var user = document.getElementById("username").value.trim();

  if (!user) {
    alert("Por favor ingrese su nombre de usuario.");
    return;
  }

  if (bl) {
    guardarHistorial(user, bl);
    if (bl === "MEDUQT871264") {
      mostrarDatosEspecificos();
    } else {
      mostrarDatosSimulados();
    }
  } else {
    alert("Por favor ingrese un número de conocimiento de embarque.");
  }
}

function guardarHistorial(usuario, bl) {
  let historial = JSON.parse(localStorage.getItem('historialBL')) || {};
  if (!historial[usuario]) {
    historial[usuario] = [];
  }
  historial[usuario].unshift({ bl: bl, fecha: new Date().toLocaleString() });
  historial[usuario] = historial[usuario].slice(0, 10);
  localStorage.setItem('historialBL', JSON.stringify(historial));
  mostrarHistorial();
}

function mostrarHistorial() {
  const historialDiv = document.getElementById('historialBusqueda');
  const user = document.getElementById("username")?.value.trim();
  historialDiv.innerHTML = `<h3>Historial de búsqueda</h3>`;
  if (!user) {
    historialDiv.innerHTML += `<p>Ingrese su nombre para ver historial.</p>`;
    return;
  }
  const historial = JSON.parse(localStorage.getItem('historialBL')) || {};
  if (!historial[user] || historial[user].length === 0) {
    historialDiv.innerHTML += `<p>No hay búsquedas recientes.</p>`;
    return;
  }
  const lista = document.createElement('ul');
  historial[user].forEach(item => {
    const li = document.createElement('li');
    li.textContent = `BL: ${item.bl} - ${item.fecha}`;
    lista.appendChild(li);
  });
  historialDiv.appendChild(lista);
}

function mostrarHistorialCompleto() {
  const historialDiv = document.getElementById('historialBusqueda');
  const user = document.getElementById("username")?.value.trim();
  historialDiv.innerHTML = `<h3>Historial completo de búsqueda</h3>`;
  if (!user) {
    historialDiv.innerHTML += `<p>Ingrese su nombre para ver historial.</p>`;
    return;
  }
  const historial = JSON.parse(localStorage.getItem('historialBL')) || {};
  if (!historial[user] || historial[user].length === 0) {
    historialDiv.innerHTML += `<p>No hay búsquedas recientes.</p>`;
    return;
  }
  const lista = document.createElement('ul');
  historial[user].forEach(item => {
    const li = document.createElement('li');
    li.textContent = `BL: ${item.bl} - ${item.fecha}`;
    lista.appendChild(li);
  });
  historialDiv.appendChild(lista);
}

function mostrarAyuda() {
  alert("Ingrese su nombre de usuario y el número de conocimiento de embarque para seguir el progreso de su carga. Luego, puede visualizar el mapa, el historial de eventos y los detalles de su carga.");
}

function mostrarImagen(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.src = e.target.result;
      const imageContainer = document.getElementById('imageContainer');
      imageContainer.innerHTML = `<p>Imagen cargada para el BL: ${document.getElementById("blNumber").value}</p>`;
      imageContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  }
}

function mostrarDatosEspecificos() {
  const ruta = [
    { name: "Qingdao, CN", evento: "Empty to Shipper", fecha: "10 Feb 2025 00:00", coords: [36.0671, 120.3826] },
    { name: "Qingdao, CN", evento: "Export received at CY", fecha: "16 Feb 2025 00:00", coords: [36.0671, 120.3826] },
    { name: "Qingdao, CN", evento: "Export Loaded on Vessel", fecha: "17 Feb 2025 00:00", coords: [36.0671, 120.3826] },
    { name: "Busan, KR", evento: "Full Transshipment Discharged", fecha: "22 Feb 2025 00:00", coords: [35.1796, 129.0756] },
    { name: "Busan, KR", evento: "Full Transshipment Loaded", fecha: "23 Feb 2025 00:00", coords: [35.1796, 129.0756] },
    { name: "Buenaventura, CO", evento: "Import Discharged from Vessel", fecha: "25 Mar 2025 00:00", coords: [3.8801, -77.0312] },
    { name: "Buenaventura, CO", evento: "Import to consignee", fecha: "4 Apr 2025 00:00", coords: [3.8801, -77.0312] },
    { name: "Buenaventura, CO", evento: "Empty received at CY", fecha: "7 Apr 2025 00:00", coords: [3.8801, -77.0312] }
  ];
  document.getElementById("puertoTiempos").innerHTML = "";
  map.eachLayer(function (layer) {
    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
      map.removeLayer(layer);
    }
  });
  const latlngs = [];
  ruta.forEach(p => {
    L.marker(p.coords).addTo(map).bindPopup(`<strong>${p.name}</strong><br>${p.evento}<br>${p.fecha}`);
    const fila = `<tr><td>${p.name}</td><td>${p.evento}</td><td>${p.fecha}</td></tr>`;
    document.getElementById("puertoTiempos").innerHTML += fila;
    latlngs.push(p.coords);
  });
  L.polyline(latlngs, {color: 'blue'}).addTo(map);
  map.setView(ruta[0].coords, 3);
}

function mostrarDatosSimulados() {
  const datosSimulados = [
    { name: "Puerto de Shanghai", evento: "Llegada estimada", fecha: "15 May 2025", coords: [31.2304, 121.4737] },
    { name: "Puerto de Cartagena", evento: "En tránsito", fecha: "25 May 2025", coords: [10.4000, -75.5167] },
    { name: "Puerto de Rotterdam", evento: "Descarga estimada", fecha: "5 Jun 2025", coords: [51.9225, 4.4792] }
  ];
  document.getElementById("puertoTiempos").innerHTML = "";
  map
